<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Catchment Area Service Mapping â€” Interactive Dashboard</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables -->
  <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
     :root {
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --accent-color: #1abc9c;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
    }
    
   body { 
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 0.9rem;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }
    
    .dashboard-header {
      background: linear-gradient(to right, rgb(27, 101, 124), rgb(20, 75, 92));
      color: white;
      padding: 1rem 0;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    
    .card { 
      border: none;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(21, 33, 62, 0.08);
      transition: transform 0.3s, box-shadow 0.3s;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(21, 33, 62, 0.12);
    }
    
    .card-header {
      background: linear-gradient(to right, var(--secondary-color), var(--accent-color));
      color: white;
      border-radius: 8px 8px 0 0 !important;
      padding: 0.75rem 1rem;
      font-weight: 600;
      font-size: 0.95rem;
    }
    
    #detailModal .modal-dialog { 
      max-width: 1400px; 
    }
    
    #modalMap, #mainMap { 
      height: 400px; 
      width: 100%; 
      border-radius: 6px;
      z-index: 1;
    }
    
    .file-fallback { 
      display:flex; 
      gap:8px; 
      align-items:center; 
    }
    
    .small-muted { 
      font-size:0.8rem; 
      color:#6c757d; 
    }
    
    .btn-primary {
      background: var(--secondary-color);
      border: none;
      border-radius: 5px;
      padding: 0.4rem 1rem;
      font-weight: 500;
      font-size: 0.85rem;
    }
    
    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .nav-tabs .nav-link {
      color: var(--dark-color);
      font-weight: 500;
      border-radius: 6px 6px 0 0;
      font-size: 0.85rem;
      padding: 0.5rem 0.75rem;
    }
    
    .nav-tabs .nav-link.active {
      background: var(--light-color);
      color: var(--primary-color);
      border-bottom: 3px solid var(--accent-color);
    }
    
    .stats-card {
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      background: white;
      box-shadow: 0 3px 10px rgba(0,0,0,0.06);
      transition: all 0.3s ease;
      height: 100%;
    }
    
    .stats-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .stats-number {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--secondary-color);
      margin-bottom: 0.25rem;
    }
    
    .stats-label {
      font-size: 0.8rem;
      color: var(--dark-color);
      font-weight: 500;
    }
    
    .feature-icon {
      font-size: 1.2rem;
      margin-right: 8px;
      color: var(--accent-color);
    }
    
    .footer {
      margin-top: 1.5rem;
      padding: 0.75rem 0;
      color: var(--dark-color);
      font-size: 0.8rem;
    }
    
    .map-container {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    
    .map-overlay {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255,255,255,0.95);
      padding: 6px;
      border-radius: 6px;
      z-index: 1000;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    
    .table-hover tbody tr:hover {
      background-color: rgba(52, 152, 219, 0.08);
      cursor: pointer;
      transform: scale(1.005);
      transition: all 0.2s ease;
    }
    
    .service-card {
      border-left: 3px solid var(--accent-color);
      background: white;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
    }
    
    .service-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
    }
    
    .service-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }
    
    .service-title {
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
      font-size: 0.95rem;
    }
    
    .service-provider {
      color: var(--secondary-color);
      font-weight: 500;
      font-size: 0.85rem;
    }
    
    .service-details {
      font-size: 0.8rem;
    }
    
    .service-detail {
      margin-bottom: 0.4rem;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .service-detail:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    .detail-key {
      font-weight: 600;
      color: #2c5aa0;
      min-width: 120px;
      display: inline-block;
    }
    
    .detail-value {
      color: #555;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
    }
    
    .sector-badge {
      background: linear-gradient(45deg, var(--accent-color), var(--secondary-color));
      color: white;
      padding: 3px 8px;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 500;
      margin: 1px;
    }
    
    .location-info-card {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      height: 100%;
    }
    
    .no-data {
      text-align: center;
      padding: 2rem;
      color: #6c757d;
    }
    
    .no-data i {
      font-size: 3rem;
      margin-bottom: 0.75rem;
      opacity: 0.3;
    }

    /* Fix for modal map initialization */
    .modal-map-container {
      height: 400px;
      width: 100%;
      border-radius: 6px;
      overflow: hidden;
    }

    /* Ensure map containers have proper dimensions */
    .leaflet-container {
      background: #f8f9fa;
    }

    /* Custom marker styles */
    .main-marker {
      background-color: #3498db;
      border: 3px solid white;
      border-radius: 50%;
      width: 16px;
      height: 16px;
    }

    .service-marker {
      background-color: #e74c3c;
      border: 2px solid white;
      border-radius: 50%;
      width: 12px;
      height: 12px;
    }
    
    /* Tab styles for service categorization */
    .service-tabs {
      margin-bottom: 1rem;
    }
    
    .service-tab-content {
      min-height: 150px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .service-count-badge {
      margin-left: 6px;
      font-size: 0.7rem;
    }
    
    .category-header {
      background: linear-gradient(to right, #f8f9fa, #e9ecef);
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 3px solid var(--secondary-color);
      font-size: 0.85rem;
    }
    
    /* Compact table styling */
    .table-sm th, .table-sm td {
      padding: 0.5rem 0.75rem;
    }
    
    /* Color-coded table headers */
    .table th {
      background: linear-gradient(to bottom, #4a6fc2, #3a5ca8);
      color: white;
      font-weight: 600;
      border-bottom: 2px solid #2c4a8a;
    }
    
    /* Color-coded column names in location info */
    .location-info-key {
      font-weight: 600;
      color: #2c5aa0;
      min-width: 140px;
      display: inline-block;
    }
    
    .location-info-value {
      color: #555;
    }
    
    /* Color-coded popup content */
    .popup-key {
      font-weight: 600;
      color: #2c5aa0;
    }
    
    .popup-value {
      color: #555;
    }
    
    /* Clickable location names */
    .clickable-location {
      color: #3498db;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    
    .clickable-location:hover {
      color: #2980b9;
      text-decoration: underline;
    }
    
    /* Go to location button */
    .go-to-location-btn {
      background: #1abc9c;
      border: none;
      border-radius: 4px;
      color: white;
      padding: 0.2rem 0.5rem;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-left: 5px;
    }
    
    .go-to-location-btn:hover {
      background: #16a085;
      transform: translateY(-1px);
    }
    
    /* Compact form controls */
    .form-control, .form-select {
      padding: 0.4rem 0.75rem;
      font-size: 0.85rem;
    }
    
    /* Compact modal */
    .modal-body {
      padding: 1rem;
    }
    
    .modal-header {
      padding: 0.75rem 1rem;
    }
    
    .modal-footer {
      padding: 0.75rem 1rem;
    }
    
    /* Compact card body */
    .card-body {
      padding: 1rem;
    }
    
    /* View toggle buttons */
    .view-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .view-toggle-btn {
      flex: 1;
      padding: 8px 15px;
      border: 1px solid #dee2e6;
      background: white;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .view-toggle-btn.active {
      background: var(--secondary-color);
      color: white;
      border-color: var(--secondary-color);
    }
    
    /* Sector modal styling */
    .sector-modal .modal-dialog {
      max-width: 1200px;
    }
    
    .sector-service-card {
      border-left: 4px solid var(--accent-color);
      background: white;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
    }
    
    .sector-service-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .sector-service-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }
    
    .sector-service-title {
      font-weight: 600;
      color: var(--primary-color);
      margin: 0;
      font-size: 0.95rem;
    }
    
    .sector-service-location {
      color: var(--secondary-color);
      font-weight: 500;
      font-size: 0.85rem;
    }
    
    .sector-service-details {
      font-size: 0.8rem;
    }
    
    .sector-service-detail {
      margin-bottom: 0.4rem;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .sector-service-detail:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    /* Mobile-specific fixes */
    @media (max-width: 768px) {
      .stats-number {
        font-size: 1.5rem;
      }
      
      .card-header {
        padding: 0.6rem 0.8rem;
      }
      
      #modalMap, #mainMap {
        height: 300px;
      }
      
      .modal-map-container {
        height: 300px;
      }
      
      .detail-key, .location-info-key {
        min-width: 100px;
      }
      
      .view-toggle {
        flex-direction: column;
      }
      
      /* Improve touch targets for mobile */
      .btn, .nav-link, .clickable-location, .view-details-btn, .go-to-location-btn {
        min-height: 44px;
        min-width: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: manipulation;
      }
      
      /* Improve table touch interactions */
      .table-hover tbody tr {
        padding: 8px 0;
      }
      
      /* Fix modal for mobile */
      .modal-dialog {
        margin: 10px;
        width: calc(100% - 20px);
        max-height: 90vh;
      }
      
      .modal-content {
        max-height: 90vh;
        overflow-y: auto;
      }
      
      /* Improve map controls for touch */
      .leaflet-control-zoom a {
        width: 40px;
        height: 40px;
        line-height: 40px;
        font-size: 18px;
      }
      
      .map-overlay .btn-group-sm .btn {
        min-height: 36px;
        min-width: 36px;
      }
      
      /* Better touch feedback */
      .card, .service-card, .stats-card, .table-hover tbody tr {
        -webkit-tap-highlight-color: rgba(0,0,0,0.1);
        transition: all 0.2s ease;
      }
      
      .card:active, .service-card:active, .stats-card:active, .table-hover tbody tr:active {
        transform: scale(0.98);
        background-color: rgba(0,0,0,0.02);
      }
    }
    
    /* Cross-browser compatibility */
    @media (max-width: 576px) {
      .container {
        padding-left: 10px;
        padding-right: 10px;
      }
      
      .dashboard-header .container {
        padding-left: 15px;
        padding-right: 15px;
      }
      
      .modal-body {
        padding: 0.75rem;
      }
      
      .location-info-card, .service-card {
        padding: 0.75rem;
      }
    }
    
    /* Prevent text selection on interactive elements */
    .clickable-location, .btn, .nav-link, .view-details-btn, .go-to-location-btn {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    
    /* Fix for iOS Safari */
    @supports (-webkit-touch-callout: none) {
      .map-container, #mainMap, #modalMap, #sectorModalMap {
        -webkit-overflow-scrolling: touch;
      }
      
      body {
        -webkit-overflow-scrolling: touch;
      }
    }
    
    /* Fix for Chrome mobile */
    @media (max-width: 768px) {
      .dataTables_wrapper .dataTables_filter input,
      .dataTables_wrapper .dataTables_length select {
        font-size: 16px; /* Prevents zoom on focus in iOS */
      }
    }

    /* Compact grid adjustments */
    .compact-grid .row {
      margin-bottom: 0.5rem;
    }
    
    .compact-grid [class*="col-"] {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    
    /* Pinned marker styles */
    .pinned-marker {
      background: none !important;
      border: none !important;
    }
    
    /* Auto-load notification */
    .auto-load-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #1abc9c;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 10000;
      font-size: 0.8rem;
    }
    
    /* Column visibility controls */
    .column-visibility-controls {
      background: #f8f9fa;
      padding: 0.5rem 1rem;
      border-bottom: 1px solid #dee2e6;
    }
    
    .column-checkbox {
      margin-right: 10px;
      font-size: 0.8rem;
    }
    
    .column-checkbox input {
      margin-right: 5px;
    }

    /* Add this to your existing CSS */
    .map-container {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      height: 100%;
      min-height: 400px;
    }

    /* Ensure the map itself fills the container */
    #mainMap {
      height: 100%;
      width: 100%;
    }

    /* Fix for card body in map card */
    .card-body.p-0 {
      height: 100%;
    }

    /* Loading animation improvements */
    .spinner-border {
      animation-duration: 0.75s;
    }

    /* Floating Chart Button with Title */
    .floating-chart-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .floating-chart-title {
      background: rgba(27, 101, 124, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      max-width: 200px;
      text-align: center;
    }
    
    .floating-chart-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3498db, #1abc9c);
      color: white;
      border: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .floating-chart-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .floating-chart-btn:active {
      transform: scale(0.95);
    }
    
    /* Chart Modal */
    .chart-modal .modal-dialog {
      max-width: 1000px;
    }
    
    .chart-container {
      height: 300px;
      margin-bottom: 2rem;
    }
    
    .chart-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 1rem;
      text-align: center;
      border-bottom: 2px solid var(--accent-color);
      padding-bottom: 0.5rem;
    }
    
    .chart-tabs .nav-link {
      font-size: 0.85rem;
      padding: 0.5rem 1rem;
    }
    
    .chart-card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
      height: 100%;
    }

    /* Enhanced chart labels */
    .chart-label-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }
    
    .chart-label-item {
      display: flex;
      align-items: center;
      font-size: 0.8rem;
      padding: 4px 8px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid;
    }
    
    .chart-label-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
    }
    
    /* Add styles for the new chart containers */
    .chart-row {
      margin-bottom: 2rem;
    }
    
    .chart-note {
      font-size: 0.8rem;
      color: #6c757d;
      text-align: center;
      margin-top: 0.5rem;
    }

    .chart-note {
      font-size: 0.8rem;
      color: #6c757d;
      text-align: center;
      margin-top: 0.5rem;
    }

    /* Add this new style for map labels */
     .map-label {
      font-weight: bold;
      font-size: 12px;
      text-shadow: 1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white;
      pointer-events: none;
    }
    
    /* Floating Chart Button with Title */
    .floating-chart-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }
    
    .floating-chart-title {
      background: rgba(27, 101, 124, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      max-width: 200px;
      text-align: center;
    }
    
    .floating-chart-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #3498db, #1abc9c);
      color: white;
      border: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .floating-chart-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .floating-chart-btn:active {
      transform: scale(0.95);
    }
    
    /* Filter controls styling */
    .filter-controls {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 1rem;
    }
    
    .filter-row {
      margin-bottom: 0.75rem;
    }
    
    .filter-label {
      font-weight: 600;
      color: var(--primary-color);
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }
 </style>
</head>
<body>

<!-- Floating Chart Button with Title -->
<div class="floating-chart-container">
  <div class="floating-chart-title">
    Analytics Dashboard
  </div>
  <button class="floating-chart-btn" id="chartButton" title="View Analytics Dashboard">
    <i class="fas fa-chart-pie"></i>
  </button>
</div>

<div class="dashboard-header">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <img src="cccmlogo.png" alt="CCCM Cluster Logo" style="height: 70px; margin-right: 15px;" class="d-none d-md-block">
        <div>
          <h1 class="mb-1" style="font-size: 1.8rem; font-weight: bold; color: rgb(236, 107, 77);">Catchment Area Service Mapping</h1>
          <p class="mb-0" style="font-size: 0.85rem;">Interactive dashboard for visualizing and analyzing service areas across all sectors</p>
        </div>
      </div>
      <div class="text-end d-none d-md-block">
        <div class="small-muted" id="fileStatus" style="color: white;">Updated as of September 2025</div>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="text-center">
      <div class="spinner-border text-light mb-2" style="width: 2.5rem; height: 2.5rem;" role="status"></div>
      <div id="processingDetails" class="h5" style="font-size: 1.1rem;">Processing Excel File...</div>
      <div class="mt-2">
        <div class="spinner-border spinner-border-sm text-light me-2" role="status"></div>
        <span>Reading sheets...</span>
      </div>
    </div>
  </div>

  <div class="row compact-grid mb-3">
    <div class="col-6 col-md-3 mb-2">
      <div class="stats-card">
        <div class="stats-number" id="totalLocations">0</div>
        <div class="stats-label"><i class="fas fa-map-marker-alt me-1"></i>Community Centers</div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="stats-card">
        <div class="stats-number" id="totalServices">0</div>
        <div class="stats-label"><i class="fas fa-hands-helping me-1"></i>Service Providers</div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="stats-card">
        <div class="stats-number" id="serviceSheets">0</div>
        <div class="stats-label"><i class="fas fa-layer-group me-1"></i>Woredas</div>
      </div>
    </div>
    <div class="col-6 col-md-3 mb-2">
      <div class="stats-card">
        <div style="font-size: 2rem; color: var(--accent-color); margin-bottom: 0.5rem;">
          <!-- Icon removed -->
        </div>
        <div class="stats-label" style="font-size: 0.9rem; font-weight: 600;">Community First Approach</div>
      </div>
    </div>
  </div>

  <!-- Filter Controls -->
  <div class="filter-controls">
    <h6 class="mb-3"><i class="fas fa-filter me-2"></i>Filter Locations</h6>
    <div class="row compact-grid filter-row">
      <div class="col-md-3">
        <div class="filter-label">Region</div>
        <select class="form-select form-select-sm" id="regionFilter">
          <option value="">All Regions</option>
        </select>
      </div>
      <div class="col-md-3">
        <div class="filter-label">Zone</div>
        <select class="form-select form-select-sm" id="zoneFilter">
          <option value="">All Zones</option>
        </select>
      </div>
      <div class="col-md-3">
        <div class="filter-label">Woreda</div>
        <select class="form-select form-select-sm" id="woredaFilter">
          <option value="">All Woredas</option>
        </select>
      </div>
      <div class="col-md-3">
        <div class="filter-label">Community Center</div>
        <select class="form-select form-select-sm" id="communityCenterFilter">
          <option value="">All Community Centers</option>
        </select>
      </div>
    </div>
    <div class="row compact-grid">
      <div class="col-md-12 text-end">
        <button class="btn btn-sm btn-outline-secondary" id="resetFilters">
          <i class="fas fa-undo me-1"></i>Reset Filters
        </button>
      </div>
    </div>
  </div>

  <div class="row compact-grid align-items-stretch">
    <div class="col-lg-8 mb-3">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <i class="fas fa-map me-2"></i>Service Locations Map
          </div>
        </div>
        <div class="card-body p-0">
          <div class="map-container h-100">
            <div id="mainMap" style="height: 100%; min-height: 400px;"></div>
            <div class="map-overlay">
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-secondary" id="zoomIn" title="Zoom In">
                  <i class="fas fa-search-plus"></i>
                </button>
                <button class="btn btn-outline-secondary" id="zoomOut" title="Zoom Out">
                  <i class="fas fa-search-minus"></i>
                </button>
                <button class="btn btn-outline-secondary" id="resetView" title="Reset View">
                  <i class="fas fa-globe-americas"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4 mb-3">
      <div class="card h-100">
        <div class="card-header d-flex align-items-center">
          <div>
            About CCCM Cluster
          </div>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <h6 style="font-size: 0.95rem; color: var(--primary-color);"><i class="fas fa-bullseye me-2"></i>Our Mission</h6>
            <p class="small" style="font-size: 0.85rem; line-height: 1.5;">
              The Camp Coordination and Camp Management (CCCM) Cluster ensures coordinated, equitable, and accountable 
              service delivery to displaced populations and affected communities.
            </p>
          </div>
          
          <div class="mb-3">
            <h6 style="font-size: 0.95rem; color: var(--primary-color);"><i class="fas fa-map-marked-alt me-2"></i>Response Area Coverage</h6>
            <p class="small" style="font-size: 0.85rem; line-height: 1.5;">
              This dashboard presents CCCM cluster's coverage area (the coverage area is the geographical location that constitutes the main entry point for the implementation of the programme where the displaced population is high) in out-of-camp settings, highlighting service providers' presence and their response. It supports gap identification, efforts for preventing duplication, and strengthening service delivery for vulnerable communities.
            </p>
          </div>
          
          <div class="mb-3">
            <h6 style="font-size: 0.95rem; color: var(--primary-color);"><i class="fas fa-hands-helping me-2"></i>Multi-Sector Coordination</h6>
            <p class="small" style="font-size: 0.85rem; line-height: 1.5;">
              The CCCM cluster coordinates across all sectors to ensure displaced communities receive comprehensive support through structured service mapping and gap analysis. As the only cluster mandated to coordinate intersectoral services including but not limited to Shelter, WASH, Health, Protection, food, etc., the CCCM cluster serves as a key accountability mechanism and a bridge between communities and humanitarian, and local government actors. CCCM also empowers affected populations to shape the response and contribute to durable solutions.
            </p>
          </div>
          
          <div class="mb-3">
            <h6 style="font-size: 0.95rem; color: var(--primary-color);"><i class="fas fa-chart-line me-2"></i>Data-Driven Response</h6>
            <p class="small" style="font-size: 0.85rem; line-height: 1.5;">
              This interactive platform enables evidence-based decision making by providing real-time visibility of service 
              distribution, provider locations, and coverage gaps across all operational areas.
            </p>
          </div>
          
          <div class="mt-4 p-3" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 6px; border-left: 4px solid var(--accent-color);">
            <p class="small mb-0" style="font-size: 0.8rem; font-style: italic; line-height: 1.4;">
              <i class="fas fa-quote-left me-1 text-muted"></i>
              Through coordinated Catchment Area Service Mapping, we ensure no community is left behind and every service reaches those who need it most.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- View Toggle -->
  <div class="view-toggle mb-3">
    <button class="view-toggle-btn active" id="locationViewBtn">
      <i class="fas fa-map-marker-alt me-2"></i>Location View
    </button>
    <button class="view-toggle-btn" id="sectorViewBtn">
      <i class="fas fa-layer-group me-2"></i>Sector View
    </button>
  </div>

  <!-- Location View Table -->
  <div class="card" id="locationView">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <i class="fas fa-table me-2"></i>Service Locations
      </div>
      <div>
        <button class="btn btn-sm btn-outline-secondary" id="toggleColumnsBtn" title="Toggle Column Visibility">
          <i class="fas fa-columns me-1"></i>Columns
        </button>
      </div>
    </div>
    
    <!-- Column Visibility Controls -->
    <div class="column-visibility-controls" id="columnControls" style="display: none;">
      <div class="row">
        <div class="col-md-12">
          <strong class="me-2" style="font-size: 0.8rem;">Show/Hide Columns:</strong>
          <div id="columnCheckboxes">
            <!-- Column checkboxes will be generated here -->
          </div>
        </div>
      </div>
    </div>
    
    <div class="card-body p-0">
      <table id="mainTable" class="table table-striped table-hover table-sm" style="width:100%">
        <thead>
          <tr>
            <th>Region</th>
            <th>Zone</th>
            <th>Woreda</th>
            <th>Community Center</th>
            <th>CCCM Agency</th>
            <th>Service Providers</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data will be populated dynamically -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Sector View Table -->
  <div class="card" id="sectorView" style="display: none;">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <i class="fas fa-layer-group me-2"></i>Service Sectors
      </div>
      <div>
        <button class="btn btn-sm btn-outline-secondary" id="toggleSectorColumnsBtn" title="Toggle Column Visibility">
          <i class="fas fa-columns me-1"></i>Columns
        </button>
      </div>
    </div>
    
    <!-- Sector Column Visibility Controls -->
    <div class="column-visibility-controls" id="sectorColumnControls" style="display: none;">
      <div class="row">
        <div class="col-md-12">
          <strong class="me-2" style="font-size: 0.8rem;">Show/Hide Columns:</strong>
          <div id="sectorColumnCheckboxes">
            <!-- Sector column checkboxes will be generated here -->
          </div>
        </div>
      </div>
    </div>
    
    <div class="card-body p-0">
      <table id="sectorTable" class="table table-striped table-hover table-sm" style="width:100%">
        <thead>
          <tr>
            <th>Sector</th>
            <th>Service Type</th>
            <th>Service Providers</th>
            <th>Locations Covered</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data will be populated dynamically -->
        </tbody>
      </table>
    </div>
  </div>

  <div class="footer text-center">
    <p class="mb-0">CCCM Cluster Ethiopia</p>
  </div>
</div>

<!-- Location Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" style="font-size: 1.1rem;"><i class="fas fa-info-circle me-2"></i>Location Details</h5>
        <div>
          <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="toggleModalColumnsBtn" title="Toggle Column Visibility">
            <i class="fas fa-columns me-1"></i>Columns
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>
      
      <!-- Modal Column Visibility Controls -->
      <div class="column-visibility-controls" id="modalColumnControls" style="display: none;">
        <div class="row">
          <div class="col-md-12">
            <strong class="me-2" style="font-size: 0.8rem;">Show/Hide Service Details:</strong>
            <div id="modalColumnCheckboxes">
              <!-- Modal column checkboxes will be generated here -->
            </div>
          </div>
        </div>
      </div>
      
      <div class="modal-body">
        <div class="row compact-grid mb-3">
          <div class="col-lg-5">
            <div class="location-info-card">
              <h6 class="mb-2" style="font-size: 0.95rem;"><i class="fas fa-location-dot me-2"></i>Location Information</h6>
              <div id="locationInfo"></div>
            </div>
          </div>
          <div class="col-lg-7">
            <div class="location-info-card">
              <h6 class="mb-2" style="font-size: 0.95rem;"><i class="fas fa-map me-2"></i>Service Locations Map</h6>
              <div class="modal-map-container">
                <div id="modalMap"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="location-info-card">
          <h6 class="mb-2" style="font-size: 0.95rem;"><i class="fas fa-link me-2"></i>Linked Services</h6>
          
          <!-- Service Tabs -->
          <ul class="nav nav-tabs service-tabs" id="serviceTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="cc-tab" data-bs-toggle="tab" data-bs-target="#cc-tab-pane" type="button" role="tab" aria-controls="cc-tab-pane" aria-selected="true">
                <i class="fas fa-building me-1"></i>Community Center
                <span class="badge bg-primary service-count-badge" id="cc-count">0</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="ca-tab" data-bs-toggle="tab" data-bs-target="#ca-tab-pane" type="button" role="tab" aria-controls="ca-tab-pane" aria-selected="false">
                <i class="fas fa-map-marked-alt me-1"></i>Catchment Area
                <span class="badge bg-primary service-count-badge" id="ca-count">0</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="other-tab" data-bs-toggle="tab" data-bs-target="#other-tab-pane" type="button" role="tab" aria-controls="other-tab-pane" aria-selected="false">
                <i class="fas fa-question-circle me-1"></i>Other
                <span class="badge bg-primary service-count-badge" id="other-count">0</span>
              </button>
            </li>
          </ul>
          
          <div class="tab-content service-tab-content" id="serviceTabContent">
            <div class="tab-pane fade show active" id="cc-tab-pane" role="tabpanel" aria-labelledby="cc-tab" tabindex="0">
              <div id="cc-services"></div>
            </div>
            <div class="tab-pane fade" id="ca-tab-pane" role="tabpanel" aria-labelledby="ca-tab" tabindex="0">
              <div id="ca-services"></div>
            </div>
            <div class="tab-pane fade" id="other-tab-pane" role="tabpanel" aria-labelledby="other-tab" tabindex="0">
              <div id="other-services"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Sector Detail Modal -->
<div class="modal fade sector-modal" id="sectorDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" style="font-size: 1.1rem;"><i class="fas fa-layer-group me-2"></i>Sector Details</h5>
        <div>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>
      
      <div class="modal-body">
        <div class="row compact-grid mb-3">
          <div class="col-lg-4">
            <div class="location-info-card">
              <h6 class="mb-2" style="font-size: 0.95rem;"><i class="fas fa-info-circle me-2"></i>Sector Information</h6>
              <div id="sectorInfo"></div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="location-info-card">
              <h6 class="mb-2" style="font-size: 0.95rem;"><i class="fas fa-map me-2"></i>Sector Coverage Map</h6>
              <div class="modal-map-container">
                <div id="sectorModalMap"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="location-info-card">
          <h6 class="mb-2" style="font-size: 0.95rem;"><i class="fas fa-hands-helping me-2"></i>Service Providers</h6>
          <div id="sectorServices"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Charts Modal -->
<div class="modal fade chart-modal" id="chartsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" style="font-size: 1.1rem;">Analytics Dashboard</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <div class="modal-body">
        <!-- Chart Tabs -->
        <ul class="nav nav-tabs chart-tabs mb-4" id="chartTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="providers-chart-tab" data-bs-toggle="tab" data-bs-target="#providers-chart-pane" type="button" role="tab" aria-controls="providers-chart-pane" aria-selected="true">
              <i class="fas fa-hands-helping me-1"></i>Service Providers
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="distribution-chart-tab" data-bs-toggle="tab" data-bs-target="#distribution-chart-pane" type="button" role="tab" aria-controls="distribution-chart-pane" aria-selected="false">
              <i class="fas fa-layer-group me-1"></i>Sector Distribution
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="cccm-chart-tab" data-bs-toggle="tab" data-bs-target="#cccm-chart-pane" type="button" role="tab" aria-controls="cccm-chart-pane" aria-selected="false">
              <i class="fas fa-users me-1"></i>CCCM Partners
            </button>
          </li>
        </ul>
        
        <div class="tab-content" id="chartTabContent">
          <!-- Service Providers Chart Tab -->
          <div class="tab-pane fade show active" id="providers-chart-pane" role="tabpanel" aria-labelledby="providers-chart-tab" tabindex="0">
            <div class="row chart-row">
              <div class="col-md-6">
                <div class="chart-card">
                  <div class="chart-title">Top 5 Service Providers by Sector</div>
                  <div class="chart-container">
                    <canvas id="topProvidersBySectorChart"></canvas>
                  </div>
                  <p class="chart-note">Showing the top 5 service providers with the most locations covered across all sectors</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="chart-card">
                  <div class="chart-title">Top 5 Locations Covered by Sector</div>
                  <div class="chart-container">
                    <canvas id="topLocationsBySectorChart"></canvas>
                  </div>
                  <p class="chart-note">Showing the top 5 locations with the most service providers across all sectors</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Sector Distribution Chart Tab -->
          <div class="tab-pane fade" id="distribution-chart-pane" role="tabpanel" aria-labelledby="distribution-chart-tab" tabindex="0">
            <div class="row chart-row">
              <div class="col-12">
                <div class="chart-card">
                  <div class="chart-title">Service Provider Distribution by Sector</div>
                  <div class="chart-container">
                    <canvas id="providerSectorDistributionChart"></canvas>
                  </div>
                  <p class="chart-note">Distribution of service providers across different sectors</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- CCCM Partners Chart Tab -->
          <div class="tab-pane fade" id="cccm-chart-pane" role="tabpanel" aria-labelledby="cccm-chart-tab" tabindex="0">
            <div class="row chart-row">
              <div class="col-12">
                <div class="chart-card">
                  <div class="chart-title">CCCM Partners - Community Centers and Woredas</div>
                  <div class="chart-container">
                    <canvas id="cccmPartnersChart"></canvas>
                  </div>
                  <p class="chart-note">CCCM partners showing the number of community centers they manage and woredas they work in</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- JS libs -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
// Global variables
let workbookData = null;
let mainSheetData = [];
let serviceSheets = {};
let dataTable = null;
let sectorTable = null;
let mainMap = null;
let modalMap = null;
let sectorModalMap = null;
let markersLayer = null;
let locationMarkers = {}; // Store markers by location index for quick access
let pinnedMarkers = []; // Store pinned markers for the modal map
let currentModalLocation = null; // Store current modal location for refreshing
let currentView = 'location'; // Current view: 'location' or 'sector'

// Chart instances
let topProvidersBySectorChart = null;
let topLocationsBySectorChart = null;
let providerSectorDistributionChart = null;
let cccmPartnersChart = null;

// Filter variables
let currentFilters = {
  region: '',
  zone: '',
  woreda: '',
  communityCenter: ''
};

// Column configuration - EASILY CUSTOMIZE VISIBLE COLUMNS HERE
const columnConfig = [
  { 
    data: 'region', 
    title: 'Region', 
    visible: true,
    className: ''
  },
  { 
    data: 'zone', 
    title: 'Zone', 
    visible: true,
    className: ''
  },
  { 
    data: 'woreda', 
    title: 'Woreda', 
    visible: true,
    className: ''
  },
  { 
    data: 'community_center', 
    title: 'Community Center', 
    visible: true,
    className: ''
  },
  { 
    data: 'cccm_agency', 
    title: 'CCCM Agency', 
    visible: true,
    className: ''
  },
  { 
    data: 'linked_services', 
    title: 'Service Providers', 
    visible: true,
    className: 'text-center'
  }
];

// Sector column configuration
const sectorColumnConfig = [
  { 
    data: 'sector', 
    title: 'Sector', 
    visible: true,
    className: ''
  },
  { 
    data: 'service_type', 
    title: 'Service Type', 
    visible: true,
    className: ''
  },
  { 
    data: 'service_providers', 
    title: 'Service Providers', 
    visible: true,
    className: 'text-center'
  },
  { 
    data: 'locations_covered', 
    title: 'Locations Covered', 
    visible: true,
    className: 'text-center'
  },
  { 
    data: 'details', 
    title: 'Details', 
    visible: true,
    className: 'text-center'
  }
];

// Modal column configuration - Control which service details are visible
const modalColumnConfig = [
  { 
    id: 'services_provided',
    title: 'Services Provided', 
    visible: true,
    key: 'Services'
  },
  { 
    id: 'focal_person',
    title: 'Focal Person', 
    visible: true,
    key: 'Focal Person Name'
  },
  { 
    id: 'phone',
    title: 'Phone Number', 
    visible: true,
    key: 'Phone Number'
  },
  { 
    id: 'coordinates',
    title: 'Coordinates', 
    visible: true,
    key: '_coordinates'
  },
  { 
    id: 'map_action',
    title: 'Map Actions', 
    visible: true,
    key: '_mapAction'
  }
];

// Color scheme for different service types
const serviceColors = {
  'food_ca': '#e74c3c',
  'food_cc': '#c0392b',
  'wash_ca': '#3498db', 
  'wash_cc': '#2980b9',
  'shelter_ca': '#2ecc71',
  'shelter_cc': '#27ae60',
  'health_ca': '#9b59b6',
  'health_cc': '#8e44ad',
  'protection_ca': '#f39c12',
  'protection_cc': '#d35400',
  'education_ca': '#1abc9c',
  'education_cc': '#16a085',
  'nfis_ca': '#34495e',
  'nfis_cc': '#2c3e50',
  'default': '#7f8c8d'
};

// Updated chart color scheme with your specified colors
const chartColors = {
  primary: ['#1b657c', '#1b657c', '#1b657c', '#1b657c', '#1b657c'], // Using your specified color for all bars
  accent: '#1b657c' // Your specified color: rgb(27, 101, 124)
};

// Show loading overlay
function showLoading(message = 'Processing Excel File...') {
  document.getElementById('loadingOverlay').style.display = 'flex';
  document.getElementById('processingDetails').textContent = message;
}

// Hide loading overlay
function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}

// Show auto-load notification
function showAutoLoadNotification(message) {
  // Remove existing notification
  const existingNotification = document.querySelector('.auto-load-notification');
  if (existingNotification) {
    existingNotification.remove();
  }
  
  // Create new notification
  const notification = document.createElement('div');
  notification.className = 'auto-load-notification';
  notification.innerHTML = `
    <i class="fas fa-info-circle me-2"></i>${message}
  `;
  document.body.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.remove();
    }
  }, 5000);
}

// Initialize main map
function initializeMainMap() {
  // Default center coordinates (Ethiopia)
  mainMap = L.map('mainMap').setView([9.145, 40.4897], 6);
  
  // Add tile layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(mainMap);
  
  // Initialize markers layer
  markersLayer = L.layerGroup().addTo(mainMap);
  
  // Map control buttons
  document.getElementById('zoomIn').addEventListener('click', () => mainMap.zoomIn());
  document.getElementById('zoomOut').addEventListener('click', () => mainMap.zoomOut());
  document.getElementById('resetView').addEventListener('click', () => mainMap.setView([9.145, 40.4897], 6));
}

// Initialize modal map
function initializeModalMap() {
  if (modalMap) {
    modalMap.remove();
  }
  
  modalMap = L.map('modalMap').setView([9.145, 40.4897], 6);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(modalMap);
  
  return modalMap;
}

// Initialize sector modal map
function initializeSectorModalMap() {
  if (sectorModalMap) {
    sectorModalMap.remove();
  }
  
  sectorModalMap = L.map('sectorModalMap').setView([9.145, 40.4897], 6);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(sectorModalMap);
  
  return sectorModalMap;
}

// Initialize column controls
function initializeColumnControls() {
  const container = document.getElementById('columnCheckboxes');
  container.innerHTML = '';
  
  columnConfig.forEach((column, index) => {
    const checkbox = document.createElement('span');
    checkbox.className = 'column-checkbox';
    checkbox.innerHTML = `
      <input type="checkbox" id="col-${index}" ${column.visible ? 'checked' : ''}>
      <label for="col-${index}">${column.title}</label>
    `;
    container.appendChild(checkbox);
    
    // Add event listener
    checkbox.querySelector('input').addEventListener('change', function() {
      column.visible = this.checked;
      if (dataTable) {
        dataTable.column(index).visible(this.checked);
      }
    });
  });
}

// Initialize sector column controls
function initializeSectorColumnControls() {
  const container = document.getElementById('sectorColumnCheckboxes');
  container.innerHTML = '';
  
  sectorColumnConfig.forEach((column, index) => {
    const checkbox = document.createElement('span');
    checkbox.className = 'column-checkbox';
    checkbox.innerHTML = `
      <input type="checkbox" id="sector-col-${index}" ${column.visible ? 'checked' : ''}>
      <label for="sector-col-${index}">${column.title}</label>
    `;
    container.appendChild(checkbox);
    
    // Add event listener
    checkbox.querySelector('input').addEventListener('change', function() {
      column.visible = this.checked;
      if (sectorTable) {
        sectorTable.column(index).visible(this.checked);
      }
    });
  });
}

// Initialize modal column controls
function initializeModalColumnControls() {
  const container = document.getElementById('modalColumnCheckboxes');
  container.innerHTML = '';
  
  modalColumnConfig.forEach((column, index) => {
    const checkbox = document.createElement('span');
    checkbox.className = 'column-checkbox';
    checkbox.innerHTML = `
      <input type="checkbox" id="modal-col-${index}" ${column.visible ? 'checked' : ''}>
      <label for="modal-col-${index}">${column.title}</label>
    `;
    container.appendChild(checkbox);
    
    // Add event listener
    checkbox.querySelector('input').addEventListener('change', function() {
      column.visible = this.checked;
      // Refresh modal content if it's open
      if (currentModalLocation) {
        refreshModalServices(currentModalLocation);
      }
    });
  });
}

// Toggle column controls visibility
function toggleColumnControls() {
  const controls = document.getElementById('columnControls');
  controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
}

// Toggle sector column controls visibility
function toggleSectorColumnControls() {
  const controls = document.getElementById('sectorColumnControls');
  controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
}

// Toggle modal column controls visibility
function toggleModalColumnControls() {
  const controls = document.getElementById('modalColumnControls');
  controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
}

// Switch between location and sector views
function switchView(view) {
  currentView = view;
  
  if (view === 'location') {
    document.getElementById('locationView').style.display = 'block';
    document.getElementById('sectorView').style.display = 'none';
    document.getElementById('locationViewBtn').classList.add('active');
    document.getElementById('sectorViewBtn').classList.remove('active');
  } else {
    document.getElementById('locationView').style.display = 'none';
    document.getElementById('sectorView').style.display = 'block';
    document.getElementById('locationViewBtn').classList.remove('active');
    document.getElementById('sectorViewBtn').classList.add('active');
  }
}

// Open charts modal
function openChartsModal() {
  renderCharts();
  const chartsModal = new bootstrap.Modal(document.getElementById('chartsModal'));
  chartsModal.show();
}

// AUTO-LOAD EXCEL FILE FUNCTIONALITY - ADDED THIS MISSING FUNCTION
function autoLoadExcelFile() {
  showLoading('Loading Excel file...');
  
  // Replace this URL with the actual path to your Excel file
  const excelFileUrl = 'data.xlsx'; // Change this to your actual file path
  
  fetch(excelFileUrl)
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.arrayBuffer();
    })
    .then(data => {
      showLoading('Processing Excel data...');
      
      // Process the Excel file
      const workbook = XLSX.read(data, { type: 'array' });
      processWorkbook(workbook);
      
      // Show success notification
      showAutoLoadNotification('Excel file loaded successfully!');
    })
    .catch(error => {
      console.error('Error loading Excel file:', error);
      hideLoading();
      
      // Show error notification
      showAutoLoadNotification('Error loading Excel file. Please check the file path.');
      
      // For demo purposes, you can load sample data here
      // loadSampleData();
    });
}

// Process the workbook data
function processWorkbook(workbook) {
  try {
    workbookData = workbook;
    
    // Get sheet names
    const sheetNames = workbook.SheetNames;
    
    // Process main sheet (first sheet)
    const mainSheet = workbook.Sheets[sheetNames[0]];
    mainSheetData = XLSX.utils.sheet_to_json(mainSheet, { defval: '' });
    
    // Add index to each row for reference
    mainSheetData.forEach((row, index) => {
      row._index = index + 1;
      
      // Try to extract coordinates from various possible column names
      const lat = parseFloat(row.Latitude || row.latitude || row.Lat || row.lat || '');
      const lon = parseFloat(row.Longitude || row.longitude || row.Lon || row.lon || row.Lng || row.lng || '');
      
      if (!isNaN(lat) && !isNaN(lon)) {
        row._lat = lat;
        row._lon = lon;
      } else {
        row._lat = null;
        row._lon = null;
      }
    });
    
    // Process service sheets (all other sheets)
    serviceSheets = {};
    for (let i = 1; i < sheetNames.length; i++) {
      const sheetName = sheetNames[i];
      const sheet = workbook.Sheets[sheetName];
      const sheetData = XLSX.utils.sheet_to_json(sheet, { defval: '' });
      
      // Add parent index reference and sheet name
      sheetData.forEach(row => {
        row._sheet = sheetName;
        
        // Try to extract coordinates for service locations
        const lat = parseFloat(row.Latitude || row.latitude || row.Lat || row.lat || '');
        const lon = parseFloat(row.Longitude || row.longitude || row.Lon || row.lon || row.Lng || row.lng || '');
        
        if (!isNaN(lat) && !isNaN(lon)) {
          row._lat = lat;
          row._lon = lon;
        } else {
          row._lat = null;
          row._lon = null;
        }
      });
      
      serviceSheets[sheetName] = sheetData;
    }
    
    // Update the dashboard with the loaded data
    updateDashboard();
    hideLoading();
    
  } catch (error) {
    console.error('Error processing workbook:', error);
    hideLoading();
    alert('Error processing Excel file: ' + error.message);
  }
}

// Update dashboard statistics
function updateStatistics() {
  // 1. Total Community Centers
  document.getElementById('totalLocations').textContent = mainSheetData.length.toLocaleString();
  
  // 2. Total Unique Service Providers
  let uniqueServiceProviders = new Set();
  Object.keys(serviceSheets).forEach(sheetName => {
    serviceSheets[sheetName].forEach(service => {
      const provider = getOrganizationName(service);
      if (provider && provider !== 'Unknown Provider') {
        uniqueServiceProviders.add(provider);
      }
    });
  });
  document.getElementById('totalServices').textContent = uniqueServiceProviders.size.toLocaleString();
  
  // 3. Total Unique Woredas
  let uniqueWoredas = new Set();
  mainSheetData.forEach(location => {
    const woreda = location.Woreda || location.woreda;
    if (woreda && woreda !== 'N/A') {
      uniqueWoredas.add(woreda);
    }
  });
  document.getElementById('serviceSheets').textContent = uniqueWoredas.size.toLocaleString();
}

// Get organization name from service data
function getOrganizationName(service) {
  return service.Organization || service.organization || service.Provider || service.provider || service.Agency || service.agency || 'Unknown Provider';
}

// Render main table
function renderMainTable() {
  const table = document.getElementById('mainTable');
  
  if (dataTable) {
    dataTable.destroy();
  }
  
  dataTable = $('#mainTable').DataTable({
    data: [],
    columns: columnConfig.map(col => ({
      data: col.data,
      className: col.className,
      visible: col.visible
    })),
    pageLength: 10,
    responsive: true,
    order: [[0, 'asc']],
    language: {
      search: "Filter:",
      lengthMenu: "Show _MENU_ entries"
    }
  });
  
  // Populate table with data
  mainSheetData.forEach(location => {
    // Count unique service providers
    let uniqueProviders = new Set();
    Object.keys(serviceSheets).forEach(sheetName => {
      const linked = serviceSheets[sheetName].filter(service => 
        String(service._parentindex) === String(location._index));
      
      linked.forEach(service => {
        const provider = getOrganizationName(service);
        uniqueProviders.add(provider);
      });
    });
    
    const linkedCount = uniqueProviders.size;
    
    // Make location name clickable if coordinates are available
    const locationName = location['Community Center'] || 'Location ' + location._index;
    const locationDisplay = !isNaN(location._lat) && !isNaN(location._lon) 
      ? `<span class="clickable-location" data-index="${location._index}">${locationName}</span>`
      : locationName;
    
    dataTable.row.add([
      location.Region || 'N/A',
      location.Zone || 'N/A',
      location.Woreda || 'N/A',
      locationDisplay,
      location['CCCM Agency'] || 'N/A',
      linkedCount > 0 ? 
        `<span class="badge bg-primary rounded-pill" style="font-size: 0.7rem;">${linkedCount} service provider${linkedCount !== 1 ? 's' : ''}</span>` : 
        `<span class="badge bg-secondary rounded-pill" style="font-size: 0.7rem;">No service providers</span>`
    ]).draw(false);
  });
}

// Render sector table
function renderSectorTable() {
  const sectors = getAllSectors();
  
  if (sectorTable) {
    sectorTable.destroy();
  }
  
  sectorTable = $('#sectorTable').DataTable({
    data: [],
    columns: sectorColumnConfig.map(col => ({
      data: col.data,
      className: col.className,
      visible: col.visible
    })),
    pageLength: 10,
    responsive: true,
    order: [[0, 'asc']],
    language: {
      search: "Filter:",
      lengthMenu: "Show _MENU_ entries"
    }
  });
  
  // Populate sector table
  sectors.forEach(sector => {
    const sectorServices = getSectorServices(sector);
    
    // Count unique providers
    let uniqueProviders = new Set();
    sectorServices.forEach(service => {
      const provider = getOrganizationName(service);
      if (provider && provider !== 'Unknown Provider') {
        uniqueProviders.add(provider);
      }
    });
    
    // Count unique locations
    let uniqueLocations = new Set();
    sectorServices.forEach(service => {
      if (service._parentindex) {
        uniqueLocations.add(service._parentindex);
      }
    });
    
    sectorTable.row.add([
      sector,
      getServiceType(sector),
      `<span class="badge bg-primary rounded-pill" style="font-size: 0.7rem;">${uniqueProviders.size}</span>`,
      `<span class="badge bg-info rounded-pill" style="font-size: 0.7rem;">${uniqueLocations.size}</span>`,
      `<button class="btn btn-sm btn-outline-primary view-sector-details-btn" data-sector="${sector}">
        <i class="fas fa-eye me-1"></i>View Details
      </button>`
    ]).draw(false);
  });
}

// Get all sectors from service sheets
function getAllSectors() {
  return Object.keys(serviceSheets);
}

// Get services for a specific sector
function getSectorServices(sector) {
  return serviceSheets[sector] || [];
}

// Get service type based on sector name
function getServiceType(sector) {
  if (sector.toLowerCase().includes('food')) return 'Food Assistance';
  if (sector.toLowerCase().includes('wash')) return 'Water, Sanitation & Hygiene';
  if (sector.toLowerCase().includes('shelter')) return 'Shelter & NFI';
  if (sector.toLowerCase().includes('health')) return 'Health Services';
  if (sector.toLowerCase().includes('protection')) return 'Protection';
  if (sector.toLowerCase().includes('education')) return 'Education';
  return 'Other Services';
}

// Render map with markers
function renderMap() {
  // Clear existing markers
  if (markersLayer) {
    mainMap.removeLayer(markersLayer);
  }
  
  markersLayer = L.layerGroup().addTo(mainMap);
  locationMarkers = {}; // Reset the markers storage
  
  const bounds = [];
  let validMarkers = 0;
  
  mainSheetData.forEach(location => {
    if (!isNaN(location._lat) && !isNaN(location._lon)) {
      validMarkers++;
      
      // Count unique service providers
      let uniqueProviders = new Set();
      Object.keys(serviceSheets).forEach(sheetName => {
        const linked = serviceSheets[sheetName].filter(service => 
          String(service._parentindex) === String(location._index));
        
        linked.forEach(service => {
          const provider = getOrganizationName(service);
          uniqueProviders.add(provider);
        });
      });
      
      const linkedCount = uniqueProviders.size;
      
      // Determine marker color based on linked services
      const color = linkedCount > 0 ? '#e74c3c' : '#3498db';
      const radius = linkedCount > 0 ? 6 : 5;
      
      const marker = L.circleMarker([location._lat, location._lon], {
        color: color,
        fillColor: color,
        fillOpacity: 0.7,
        radius: radius,
        weight: 1
      }).addTo(markersLayer);
      
      // Store marker for quick access
      locationMarkers[location._index] = marker;
      
      // Create popup content
      const popupContent = `
        <div style="min-width: 220px;">
          <h6 style="font-size: 0.9rem;"><strong>${location['Community Center'] || 'Location ' + location._index}</strong></h6>
          <p class="mb-1" style="font-size: 0.8rem;"><span class="popup-key">Region:</span> <span class="popup-value">${location.Region || 'N/A'}</span></p>
          <p class="mb-1" style="font-size: 0.8rem;"><span class="popup-key">Zone:</span> <span class="popup-value">${location.Zone || 'N/A'}</span></p>
          <p class="mb-1" style="font-size: 0.8rem;"><span class="popup-key">Woreda:</span> <span class="popup-value">${location.Woreda || 'N/A'}</span></p>
          <p class="mb-1" style="font-size: 0.8rem;"><span class="popup-key">CCCM Agency:</span> <span class="popup-value">${location['CCCM Agency'] || 'N/A'}</span></p>
          <p class="mb-1" style="font-size: 0.8rem;"><span class="popup-key">Service Providers:</span> <span class="popup-value">${linkedCount}</span></p>
          <p class="mb-0" style="font-size: 0.8rem;"><span class="popup-key">Coordinates:</span> <span class="popup-value">${location._lat.toFixed(6)}, ${location._lon.toFixed(6)}</span></p>
          <div class="mt-1">
            <button class="btn btn-sm btn-primary view-details-btn" data-index="${location._index}" style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">
              <i class="fas fa-info-circle me-1"></i>View Details
            </button>
          </div>
        </div>
      `;
      
      marker.bindPopup(popupContent);
      
      // Add label for community center
      const locationName = location['Community Center'] || 'Location ' + location._index;
      const label = L.marker([location._lat, location._lon], {
        icon: L.divIcon({
          className: 'map-label',
          html: locationName,
          iconSize: [100, 20],
          iconAnchor: [50, 0]
        })
      }).addTo(markersLayer);
      
      // Add click event to open modal
      marker.on('click', function() {
        openDetailModal(location);
      });
      
      bounds.push([location._lat, location._lon]);
    }
  });
  
  // Fit map to show all markers if we have any valid ones
  if (bounds.length > 0) {
    mainMap.fitBounds(bounds, { padding: [15, 15] });
  }
}

// Open detail modal for a location
function openDetailModal(location) {
  currentModalLocation = location;
  
  // Update modal title
  document.querySelector('#detailModal .modal-title').innerHTML = 
    `<i class="fas fa-info-circle me-2"></i>${location['Community Center'] || 'Location ' + location._index}`;
  
  // Update location information
  const locationInfo = document.getElementById('locationInfo');
  locationInfo.innerHTML = `
    <div class="service-detail">
      <span class="location-info-key">Region:</span>
      <span class="location-info-value">${location.Region || 'N/A'}</span>
    </div>
    <div class="service-detail">
      <span class="location-info-key">Zone:</span>
      <span class="location-info-value">${location.Zone || 'N/A'}</span>
    </div>
    <div class="service-detail">
      <span class="location-info-key">Woreda:</span>
      <span class="location-info-value">${location.Woreda || 'N/A'}</span>
    </div>
    <div class="service-detail">
      <span class="location-info-key">Community Center:</span>
      <span class="location-info-value">${location['Community Center'] || 'N/A'}</span>
    </div>
    <div class="service-detail">
      <span class="location-info-key">CCCM Agency:</span>
      <span class="location-info-value">${location['CCCM Agency'] || 'N/A'}</span>
    </div>
    <div class="service-detail">
      <span class="location-info-key">Coordinates:</span>
      <span class="location-info-value">${!isNaN(location._lat) && !isNaN(location._lon) ? 
        `${location._lat.toFixed(6)}, ${location._lon.toFixed(6)}` : 'N/A'}</span>
    </div>
  `;
  
  // Initialize modal map
  initializeModalMap();
  
  // Add main location marker to modal map
  if (!isNaN(location._lat) && !isNaN(location._lon)) {
    const mainMarker = L.circleMarker([location._lat, location._lon], {
      color: '#e74c3c',
      fillColor: '#e74c3c',
      fillOpacity: 0.8,
      radius: 8,
      weight: 2
    }).addTo(modalMap);
    
    mainMarker.bindPopup(`
      <div style="min-width: 200px;">
        <h6 style="font-size: 0.9rem;"><strong>${location['Community Center'] || 'Location ' + location._index}</strong></h6>
        <p class="mb-0" style="font-size: 0.8rem;">Main Community Center Location</p>
      </div>
    `).openPopup();
    
    modalMap.setView([location._lat, location._lon], 12);
  }
  
  // Refresh services in the modal
  refreshModalServices(location);
  
  // Show the modal
  const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
  detailModal.show();
}

// Refresh modal services content
function refreshModalServices(location) {
  // Clear previous services
  document.getElementById('cc-services').innerHTML = '';
  document.getElementById('ca-services').innerHTML = '';
  document.getElementById('other-services').innerHTML = '';
  
  let ccCount = 0;
  let caCount = 0;
  let otherCount = 0;
  
  // Process all service sheets
  Object.keys(serviceSheets).forEach(sheetName => {
    const linkedServices = serviceSheets[sheetName].filter(service => 
      String(service._parentindex) === String(location._index));
    
    linkedServices.forEach(service => {
      const serviceCard = createServiceCard(service, sheetName);
      
      // Categorize by service type
      if (sheetName.toLowerCase().includes('cc')) {
        document.getElementById('cc-services').appendChild(serviceCard);
        ccCount++;
      } else if (sheetName.toLowerCase().includes('ca')) {
        document.getElementById('ca-services').appendChild(serviceCard);
        caCount++;
      } else {
        document.getElementById('other-services').appendChild(serviceCard);
        otherCount++;
      }
    });
  });
  
  // Update service counts
  document.getElementById('cc-count').textContent = ccCount;
  document.getElementById('ca-count').textContent = caCount;
  document.getElementById('other-count').textContent = otherCount;
  
  // Show "no services" message if applicable
  if (ccCount === 0) {
    document.getElementById('cc-services').innerHTML = '<div class="no-data"><i class="fas fa-inbox"></i><p>No Community Center services found</p></div>';
  }
  if (caCount === 0) {
    document.getElementById('ca-services').innerHTML = '<div class="no-data"><i class="fas fa-inbox"></i><p>No Catchment Area services found</p></div>';
  }
  if (otherCount === 0) {
    document.getElementById('other-services').innerHTML = '<div class="no-data"><i class="fas fa-inbox"></i><p>No other services found</p></div>';
  }
}

// Create service card for modal
function createServiceCard(service, sheetName) {
  const card = document.createElement('div');
  card.className = 'service-card';
  
  const provider = getOrganizationName(service);
  const services = service.Services || service.services || 'Not specified';
  const focalPerson = service['Focal Person Name'] || service['Focal Person'] || 'Not specified';
  const phone = service['Phone Number'] || service.Phone || 'Not specified';
  
  // Get coordinates for this service if available
  const hasCoords = !isNaN(service._lat) && !isNaN(service._lon);
  const coordinates = hasCoords ? `${service._lat.toFixed(6)}, ${service._lon.toFixed(6)}` : 'Not specified';
  
  let detailsHtml = '';
  
  // Only show details that are enabled in modalColumnConfig
  modalColumnConfig.forEach(column => {
    if (column.visible) {
      let value = '';
      
      switch (column.id) {
        case 'services_provided':
          value = services;
          break;
        case 'focal_person':
          value = focalPerson;
          break;
        case 'phone':
          value = phone;
          break;
        case 'coordinates':
          value = coordinates;
          break;
        case 'map_action':
          value = hasCoords ? 
            `<button class="go-to-location-btn" data-lat="${service._lat}" data-lon="${service._lon}" data-provider="${provider}">
              <i class="fas fa-map-marker-alt me-1"></i>Show on Map
            </button>` : 
            'No coordinates';
          break;
      }
      
      if (value) {
        detailsHtml += `
          <div class="service-detail">
            <span class="detail-key">${column.title}:</span>
            <span class="detail-value">${value}</span>
          </div>
        `;
      }
    }
  });
  
  card.innerHTML = `
    <div class="service-header">
      <div>
        <h6 class="service-title">${provider}</h6>
        <div class="service-provider">${sheetName}</div>
      </div>
      <span class="sector-badge">${getServiceType(sheetName)}</span>
    </div>
    <div class="service-details">
      ${detailsHtml}
    </div>
  `;
  
  return card;
}

// Clear pinned markers from modal map
function clearPinnedMarkers() {
  pinnedMarkers.forEach(marker => {
    if (modalMap && marker) {
      modalMap.removeLayer(marker);
    }
  });
  pinnedMarkers = [];
}

// Add pinned marker to modal map
function addPinnedMarker(lat, lon, title, provider) {
  if (!modalMap) return;
  
  const marker = L.marker([lat, lon], {
    icon: L.divIcon({
      className: 'pinned-marker',
      html: '<i class="fas fa-map-pin" style="color: #e74c3c; font-size: 24px;"></i>',
      iconSize: [24, 24],
      iconAnchor: [12, 24]
    })
  }).addTo(modalMap);
  
  marker.bindPopup(`
    <div style="min-width: 200px;">
      <h6 style="font-size: 0.9rem;"><strong>${title}</strong></h6>
      <p class="mb-0" style="font-size: 0.8rem;">${provider}</p>
    </div>
  `).openPopup();
  
  pinnedMarkers.push(marker);
  modalMap.setView([lat, lon], 15);
}

// Open sector detail modal
function openSectorDetailModal(sector) {
  const sectorServices = getSectorServices(sector);
  
  // Update modal title
  document.querySelector('#sectorDetailModal .modal-title').innerHTML = 
    `<i class="fas fa-layer-group me-2"></i>${sector} - ${getServiceType(sector)}`;
  
  // Update sector information
  const sectorInfo = document.getElementById('sectorInfo');
  
  // Count unique providers and locations
  let uniqueProviders = new Set();
  let uniqueLocations = new Set();
  
  sectorServices.forEach(service => {
    const provider = getOrganizationName(service);
    if (provider && provider !== 'Unknown Provider') {
      uniqueProviders.add(provider);
    }
    if (service._parentindex) {
      uniqueLocations.add(service._parentindex);
    }
  });
  
  sectorInfo.innerHTML = `
    <div class="service-detail">
      <span class="location-info-key">Sector:</span>
      <span class="location-info-value">${sector}</span>
    </div>
    <div class="service-detail">
      <span class="location-info-key">Service Type:</span>
      <span class="location-info-value">${getServiceType(sector)}</span>
    </div>
    <div class="service-detail">
      <span class="location-info-key">Service Providers:</span>
      <span class="location-info-value">${uniqueProviders.size}</span>
    </div>
    <div class="service-detail">
      <span class="location-info-key">Locations Covered:</span>
      <span class="location-info-value">${uniqueLocations.size}</span>
    </div>
    <div class="service-detail">
      <span class="location-info-key">Total Services:</span>
      <span class="location-info-value">${sectorServices.length}</span>
    </div>
  `;
  
  // Initialize sector modal map
  initializeSectorModalMap();
  
  // Add markers for all services in this sector
  const bounds = [];
  sectorServices.forEach(service => {
    if (!isNaN(service._lat) && !isNaN(service._lon)) {
      const provider = getOrganizationName(service);
      const marker = L.circleMarker([service._lat, service._lon], {
        color: serviceColors[sector.toLowerCase()] || serviceColors.default,
        fillColor: serviceColors[sector.toLowerCase()] || serviceColors.default,
        fillOpacity: 0.7,
        radius: 6,
        weight: 1
      }).addTo(sectorModalMap);
      
      marker.bindPopup(`
        <div style="min-width: 220px;">
          <h6 style="font-size: 0.9rem;"><strong>${provider}</strong></h6>
          <p class="mb-1" style="font-size: 0.8rem;">${sector} - ${getServiceType(sector)}</p>
          <p class="mb-0" style="font-size: 0.8rem;">Coordinates: ${service._lat.toFixed(6)}, ${service._lon.toFixed(6)}</p>
        </div>
      `);
      
      bounds.push([service._lat, service._lon]);
    }
  });
  
  // Fit map to show all markers
  if (bounds.length > 0) {
    sectorModalMap.fitBounds(bounds, { padding: [15, 15] });
  } else {
    sectorModalMap.setView([9.145, 40.4897], 6);
  }
  
  // Update sector services list
  const sectorServicesContainer = document.getElementById('sectorServices');
  sectorServicesContainer.innerHTML = '';
  
  if (sectorServices.length === 0) {
    sectorServicesContainer.innerHTML = '<div class="no-data"><i class="fas fa-inbox"></i><p>No services found for this sector</p></div>';
    return;
  }
  
  // Group services by provider
  const servicesByProvider = {};
  sectorServices.forEach(service => {
    const provider = getOrganizationName(service);
    if (!servicesByProvider[provider]) {
      servicesByProvider[provider] = [];
    }
    servicesByProvider[provider].push(service);
  });
  
  // Create service cards for each provider
  Object.keys(servicesByProvider).forEach(provider => {
    const services = servicesByProvider[provider];
    const card = document.createElement('div');
    card.className = 'sector-service-card';
    
    let servicesHtml = '';
    services.forEach(service => {
      const location = mainSheetData.find(loc => String(loc._index) === String(service._parentindex));
      const locationName = location ? (location['Community Center'] || `Location ${location._index}`) : 'Unknown Location';
      
      servicesHtml += `
        <div class="sector-service-detail">
          <span class="detail-key">Location:</span>
          <span class="detail-value">${locationName}</span>
        </div>
      `;
    });
    
    card.innerHTML = `
      <div class="sector-service-header">
        <div>
          <h6 class="sector-service-title">${provider}</h6>
          <div class="sector-service-location">${services.length} location${services.length !== 1 ? 's' : ''}</div>
        </div>
      </div>
      <div class="sector-service-details">
        ${servicesHtml}
      </div>
    `;
    
    sectorServicesContainer.appendChild(card);
  });
  
  // Show the modal
  const sectorModal = new bootstrap.Modal(document.getElementById('sectorDetailModal'));
  sectorModal.show();
}

// Clear sector pinned markers
function clearSectorPinnedMarkers() {
  // Implementation for clearing sector pinned markers
}

// Add sector pinned marker
function addSectorPinnedMarker(lat, lon, title, provider) {
  // Implementation for adding sector pinned markers
}

// Setup mobile touch events
function setupMobileTouchEvents() {
  // Add touch event handlers for better mobile experience
  document.addEventListener('touchstart', function(e) {
    // Handle clickable locations in table
    if (e.target.classList.contains('clickable-location')) {
      e.preventDefault();
      const index = e.target.getAttribute('data-index');
      const location = mainSheetData.find(loc => String(loc._index) === String(index));
      if (location) {
        openDetailModal(location);
      }
    }
  }, { passive: false });
}

// Initialize filters
function initializeFilters() {
  // Get unique values for each filter
  const regions = [...new Set(mainSheetData.map(item => item.Region || item.region).filter(Boolean))].sort();
  const zones = [...new Set(mainSheetData.map(item => item.Zone || item.zone).filter(Boolean))].sort();
  const woredas = [...new Set(mainSheetData.map(item => item.Woreda || item.woreda).filter(Boolean))].sort();
  const communityCenters = [...new Set(mainSheetData.map(item => item['Community Center'] || item.community_center).filter(Boolean))].sort();
  
  // Populate region filter
  const regionFilter = document.getElementById('regionFilter');
  regions.forEach(region => {
    const option = document.createElement('option');
    option.value = region;
    option.textContent = region;
    regionFilter.appendChild(option);
  });
  
  // Populate zone filter
  const zoneFilter = document.getElementById('zoneFilter');
  zones.forEach(zone => {
    const option = document.createElement('option');
    option.value = zone;
    option.textContent = zone;
    zoneFilter.appendChild(option);
  });
  
  // Populate woreda filter
  const woredaFilter = document.getElementById('woredaFilter');
  woredas.forEach(woreda => {
    const option = document.createElement('option');
    option.value = woreda;
    option.textContent = woreda;
    woredaFilter.appendChild(option);
  });
  
  // Populate community center filter
  const communityCenterFilter = document.getElementById('communityCenterFilter');
  communityCenters.forEach(center => {
    const option = document.createElement('option');
    option.value = center;
    option.textContent = center;
    communityCenterFilter.appendChild(option);
  });
  
  // Add event listeners for filters
  document.getElementById('regionFilter').addEventListener('change', applyFilters);
  document.getElementById('zoneFilter').addEventListener('change', applyFilters);
  document.getElementById('woredaFilter').addEventListener('change', applyFilters);
  document.getElementById('communityCenterFilter').addEventListener('change', applyFilters);
  document.getElementById('resetFilters').addEventListener('click', resetFilters);
}

// Apply filters
function applyFilters() {
  // Update current filters
  currentFilters.region = document.getElementById('regionFilter').value;
  currentFilters.zone = document.getElementById('zoneFilter').value;
  currentFilters.woreda = document.getElementById('woredaFilter').value;
  currentFilters.communityCenter = document.getElementById('communityCenterFilter').value;
  
  // Filter the data
  const filteredData = mainSheetData.filter(location => {
    const regionMatch = !currentFilters.region || (location.Region || location.region) === currentFilters.region;
    const zoneMatch = !currentFilters.zone || (location.Zone || location.zone) === currentFilters.zone;
    const woredaMatch = !currentFilters.woreda || (location.Woreda || location.woreda) === currentFilters.woreda;
    const communityCenterMatch = !currentFilters.communityCenter || (location['Community Center'] || location.community_center) === currentFilters.communityCenter;
    
    return regionMatch && zoneMatch && woredaMatch && communityCenterMatch;
  });
  
  // Update table with filtered data
  updateTableWithFilteredData(filteredData);
  
  // Update map with filtered data
  updateMapWithFilteredData(filteredData);
  
  // Update statistics with filtered data
  updateStatisticsWithFilteredData(filteredData);
}

// Reset filters
function resetFilters() {
  document.getElementById('regionFilter').value = '';
  document.getElementById('zoneFilter').value = '';
  document.getElementById('woredaFilter').value = '';
  document.getElementById('communityCenterFilter').value = '';
  
  currentFilters = {
    region: '',
    zone: '',
    woreda: '',
    communityCenter: ''
  };
  
  applyFilters();
}

// Update table with filtered data
function updateTableWithFilteredData(filteredData) {
  if (dataTable) {
    dataTable.clear();
    
    filteredData.forEach(location => {
      // Count unique service providers
      let uniqueProviders = new Set();
      Object.keys(serviceSheets).forEach(sheetName => {
        const linked = serviceSheets[sheetName].filter(service => 
          String(service._parentindex) === String(location._index));
        
        linked.forEach(service => {
          const provider = getOrganizationName(service);
          uniqueProviders.add(provider);
        });
      });
      
      const linkedCount = uniqueProviders.size;
      
      // Make location name clickable if coordinates are available
      const locationName = location['Community Center'] || 'Location ' + location._index;
      const locationDisplay = !isNaN(location._lat) && !isNaN(location._lon) 
        ? `<span class="clickable-location" data-index="${location._index}">${locationName}</span>`
        : locationName;
      
      dataTable.row.add([
        location.Region || 'N/A',
        location.Zone || 'N/A',
        location.Woreda || 'N/A',
        locationDisplay,
        location['CCCM Agency'] || 'N/A',
        linkedCount > 0 ? 
          `<span class="badge bg-primary rounded-pill" style="font-size: 0.7rem;">${linkedCount} service provider${linkedCount !== 1 ? 's' : ''}</span>` : 
          `<span class="badge bg-secondary rounded-pill" style="font-size: 0.7rem;">No service providers</span>`
      ]).draw(false);
    });
  }
}

// Update map with filtered data
function updateMapWithFilteredData(filteredData) {
  // Clear existing markers
  if (markersLayer) {
    mainMap.removeLayer(markersLayer);
  }
  
  markersLayer = L.layerGroup().addTo(mainMap);
  locationMarkers = {}; // Reset the markers storage
  
  const bounds = [];
  let validMarkers = 0;
  
  filteredData.forEach(location => {
    if (!isNaN(location._lat) && !isNaN(location._lon)) {
      validMarkers++;
      
      // Count unique service providers
      let uniqueProviders = new Set();
      Object.keys(serviceSheets).forEach(sheetName => {
        const linked = serviceSheets[sheetName].filter(service => 
          String(service._parentindex) === String(location._index));
        
        linked.forEach(service => {
          const provider = getOrganizationName(service);
          uniqueProviders.add(provider);
        });
      });
      
      const linkedCount = uniqueProviders.size;
      
      // Determine marker color based on linked services
      const color = linkedCount > 0 ? '#e74c3c' : '#3498db';
      const radius = linkedCount > 0 ? 6 : 5;
      
      const marker = L.circleMarker([location._lat, location._lon], {
        color: color,
        fillColor: color,
        fillOpacity: 0.7,
        radius: radius,
        weight: 1
      }).addTo(markersLayer);
      
      // Store marker for quick access
      locationMarkers[location._index] = marker;
      
      // Create popup content
      const popupContent = `
        <div style="min-width: 220px;">
          <h6 style="font-size: 0.9rem;"><strong>${location['Community Center'] || 'Location ' + location._index}</strong></h6>
          <p class="mb-1" style="font-size: 0.8rem;"><span class="popup-key">Region:</span> <span class="popup-value">${location.Region || 'N/A'}</span></p>
          <p class="mb-1" style="font-size: 0.8rem;"><span class="popup-key">Zone:</span> <span class="popup-value">${location.Zone || 'N/A'}</span></p>
          <p class="mb-1" style="font-size: 0.8rem;"><span class="popup-key">Woreda:</span> <span class="popup-value">${location.Woreda || 'N/A'}</span></p>
          <p class="mb-1" style="font-size: 0.8rem;"><span class="popup-key">CCCM Agency:</span> <span class="popup-value">${location['CCCM Agency'] || 'N/A'}</span></p>
          <p class="mb-1" style="font-size: 0.8rem;"><span class="popup-key">Service Providers:</span> <span class="popup-value">${linkedCount}</span></p>
          <p class="mb-0" style="font-size: 0.8rem;"><span class="popup-key">Coordinates:</span> <span class="popup-value">${location._lat.toFixed(6)}, ${location._lon.toFixed(6)}</span></p>
          <div class="mt-1">
            <button class="btn btn-sm btn-primary view-details-btn" data-index="${location._index}" style="font-size: 0.75rem; padding: 0.2rem 0.5rem;">
              <i class="fas fa-info-circle me-1"></i>View Details
            </button>
          </div>
        </div>
      `;
      
      marker.bindPopup(popupContent);
      
      // Add label for community center
      const locationName = location['Community Center'] || 'Location ' + location._index;
      const label = L.marker([location._lat, location._lon], {
        icon: L.divIcon({
          className: 'map-label',
          html: locationName,
          iconSize: [100, 20],
          iconAnchor: [50, 0]
        })
      }).addTo(markersLayer);
      
      // Add click event to open modal
      marker.on('click', function() {
        openDetailModal(location);
      });
      
      bounds.push([location._lat, location._lon]);
    }
  });
  
  // Fit map to show all markers if we have any valid ones
  if (bounds.length > 0) {
    mainMap.fitBounds(bounds, { padding: [15, 15] });
  }
}

// Update statistics with filtered data
function updateStatisticsWithFilteredData(filteredData) {
  // 1. Total Community Centers
  document.getElementById('totalLocations').textContent = filteredData.length.toLocaleString();
  
  // 2. Total Unique Service Providers
  let uniqueServiceProviders = new Set();
  Object.keys(serviceSheets).forEach(sheetName => {
    serviceSheets[sheetName].forEach(service => {
      // Only count if the service is linked to a filtered location
      if (filteredData.some(location => String(location._index) === String(service._parentindex))) {
        const provider = getOrganizationName(service);
        if (provider && provider !== 'Unknown Provider') {
          uniqueServiceProviders.add(provider);
        }
      }
    });
  });
  document.getElementById('totalServices').textContent = uniqueServiceProviders.size.toLocaleString();
  
  // 3. Total Unique Woredas
  let uniqueWoredas = new Set();
  filteredData.forEach(location => {
    const woreda = location.Woreda || location.woreda;
    if (woreda && woreda !== 'N/A') {
      uniqueWoredas.add(woreda);
    }
  });
  document.getElementById('serviceSheets').textContent = uniqueWoredas.size.toLocaleString();
}

// Get chart data
function getChartData() {
  // Top Service Providers by Sector data
  const topProvidersBySector = {};
  const providerLocationCounts = {};
  
  // Count locations per provider across all sectors
  Object.keys(serviceSheets).forEach(sheetName => {
    serviceSheets[sheetName].forEach(service => {
      const provider = getOrganizationName(service);
      if (provider && provider !== 'Unknown Provider' && service._parentindex) {
        if (!providerLocationCounts[provider]) {
          providerLocationCounts[provider] = new Set();
        }
        providerLocationCounts[provider].add(service._parentindex);
      }
    });
  });
  
  // Convert to counts and get top 5 providers
  const providerCounts = {};
  Object.keys(providerLocationCounts).forEach(provider => {
    providerCounts[provider] = providerLocationCounts[provider].size;
  });
  
  const topProviders = Object.entries(providerCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  
  // Top Locations by Sector data
  const locationProviderCounts = {};
  
  // Count providers per location across all sectors
  mainSheetData.forEach(location => {
    const locationName = location['Community Center'] || `Location ${location._index}`;
    if (!locationProviderCounts[locationName]) {
      locationProviderCounts[locationName] = new Set();
    }
    
    Object.keys(serviceSheets).forEach(sheetName => {
      const linked = serviceSheets[sheetName].filter(service => 
        String(service._parentindex) === String(location._index));
      
      linked.forEach(service => {
        const provider = getOrganizationName(service);
        if (provider && provider !== 'Unknown Provider') {
          locationProviderCounts[locationName].add(provider);
        }
      });
    });
  });
  
  // Convert to counts and get top 5 locations
  const locationCounts = {};
  Object.keys(locationProviderCounts).forEach(location => {
    locationCounts[location] = locationProviderCounts[location].size;
  });
  
  const topLocations = Object.entries(locationCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  
  // Provider Distribution by Sector data - SORTED from highest to lowest
  const providerSectorDistribution = {};
  const sectors = getAllSectors();
  
  // Count providers per sector
  sectors.forEach(sector => {
    const sectorServices = getSectorServices(sector);
    let uniqueProviders = new Set();
    
    sectorServices.forEach(service => {
      const provider = getOrganizationName(service);
      if (provider && provider !== 'Unknown Provider') {
        uniqueProviders.add(provider);
      }
    });
    
    providerSectorDistribution[sector] = uniqueProviders.size;
  });
  
  // Sort sectors by provider count (highest to lowest)
  const sortedSectors = Object.entries(providerSectorDistribution)
    .sort((a, b) => b[1] - a[1]);
  
  const sortedProviderSectorDistribution = {};
  sortedSectors.forEach(([sector, count]) => {
    sortedProviderSectorDistribution[sector] = count;
  });
  
  // CCCM Partners data
  const cccmPartnersData = {};
  
  // Count community centers and woredas per CCCM agency
  mainSheetData.forEach(location => {
    const agency = location['CCCM Agency'] || 'Unknown Agency';
    if (agency && agency !== 'N/A' && agency !== 'Unknown Agency') {
      if (!cccmPartnersData[agency]) {
        cccmPartnersData[agency] = {
          communityCenters: new Set(),
          woredas: new Set()
        };
      }
      
      // Add community center
      const centerName = location['Community Center'] || `Location ${location._index}`;
      cccmPartnersData[agency].communityCenters.add(centerName);
      
      // Add woreda
      const woreda = location.Woreda || location.woreda;
      if (woreda && woreda !== 'N/A') {
        cccmPartnersData[agency].woredas.add(woreda);
      }
    }
  });
  
  // Convert to chart data format
  const cccmPartnersChartData = {
    agencies: [],
    communityCenters: [],
    woredas: []
  };
  
  Object.entries(cccmPartnersData).forEach(([agency, data]) => {
    cccmPartnersChartData.agencies.push(agency);
    cccmPartnersChartData.communityCenters.push(data.communityCenters.size);
    cccmPartnersChartData.woredas.push(data.woredas.size);
  });
  
  return {
    topProvidersData: {
      providers: topProviders.map(item => item[0]),
      counts: topProviders.map(item => item[1])
    },
    topLocationsData: {
      locations: topLocations.map(item => item[0]),
      counts: topLocations.map(item => item[1])
    },
    providerSectorDistribution: sortedProviderSectorDistribution,
    cccmPartnersData: cccmPartnersChartData
  };
}

// Render charts
function renderCharts() {
  const chartData = getChartData();
  
  // Destroy existing charts if they exist
  if (topProvidersBySectorChart) {
    topProvidersBySectorChart.destroy();
  }
  if (topLocationsBySectorChart) {
    topLocationsBySectorChart.destroy();
  }
  if (providerSectorDistributionChart) {
    providerSectorDistributionChart.destroy();
  }
  if (cccmPartnersChart) {
    cccmPartnersChart.destroy();
  }
  
  // Top 5 Service Providers by Sector Chart
  const topProvidersCtx = document.getElementById('topProvidersBySectorChart').getContext('2d');
  topProvidersBySectorChart = new Chart(topProvidersCtx, {
    type: 'bar',
    data: {
      labels: chartData.topProvidersData.providers,
      datasets: [{
        label: 'Number of Locations Covered',
        data: chartData.topProvidersData.counts,
        backgroundColor: chartColors.primary,
        borderColor: chartColors.accent,
        borderWidth: 1,
        borderRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Locations: ${context.raw}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Number of Locations'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Service Provider'
          }
        }
      }
    }
  });
  
  // Top 5 Locations Covered by Sector Chart
  const topLocationsCtx = document.getElementById('topLocationsBySectorChart').getContext('2d');
  topLocationsBySectorChart = new Chart(topLocationsCtx, {
    type: 'bar',
    data: {
      labels: chartData.topLocationsData.locations,
      datasets: [{
        label: 'Number of Service Providers',
        data: chartData.topLocationsData.counts,
        backgroundColor: chartColors.primary,
        borderColor: chartColors.accent,
        borderWidth: 1,
        borderRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Service Providers: ${context.raw}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Number of Service Providers'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Location'
          }
        }
      }
    }
  });
  
  // Provider Distribution by Sector Chart - SORTED from highest to lowest
  const providerSectorCtx = document.getElementById('providerSectorDistributionChart').getContext('2d');
  providerSectorDistributionChart = new Chart(providerSectorCtx, {
    type: 'bar',
    data: {
      labels: Object.keys(chartData.providerSectorDistribution),
      datasets: [{
        label: 'Number of Service Providers',
        data: Object.values(chartData.providerSectorDistribution),
        backgroundColor: chartColors.primary,
        borderColor: chartColors.accent,
        borderWidth: 1,
        borderRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Providers: ${context.raw}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Number of Service Providers'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Sector'
          }
        }
      }
    }
  });
  
  // CCCM Partners Chart
  const cccmPartnersCtx = document.getElementById('cccmPartnersChart').getContext('2d');
  cccmPartnersChart = new Chart(cccmPartnersCtx, {
    type: 'bar',
    data: {
      labels: chartData.cccmPartnersData.agencies,
      datasets: [
        {
          label: 'Community Centers',
          data: chartData.cccmPartnersData.communityCenters,
          backgroundColor: '#1b657c',
          borderColor: '#1b657c',
          borderWidth: 1,
          borderRadius: 5
        },
        {
          label: 'Woredas',
          data: chartData.cccmPartnersData.woredas,
          backgroundColor: '#3498db',
          borderColor: '#3498db',
          borderWidth: 1,
          borderRadius: 5
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const datasetLabel = context.dataset.label || '';
              return `${datasetLabel}: ${context.raw}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Count'
          }
        },
        x: {
          title: {
            display: true,
            text: 'CCCM Agency'
          }
        }
      }
    }
  });
}

// Update dashboard
function updateDashboard() {
  updateStatistics();
  initializeFilters();
  renderMainTable();
  renderSectorTable();
  renderMap();
  setupMobileTouchEvents();
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Initialize main map
  initializeMainMap();
  
  // Initialize column controls
  initializeColumnControls();
  
  // Initialize sector column controls
  initializeSectorColumnControls();
  
  // Initialize modal column controls
  initializeModalColumnControls();
  
  // Toggle column controls button
  document.getElementById('toggleColumnsBtn').addEventListener('click', toggleColumnControls);
  
  // Toggle sector column controls button
  document.getElementById('toggleSectorColumnsBtn').addEventListener('click', toggleSectorColumnControls);
  
  // Toggle modal column controls button
  document.getElementById('toggleModalColumnsBtn').addEventListener('click', toggleModalColumnControls);
  
  // View toggle buttons
  document.getElementById('locationViewBtn').addEventListener('click', () => switchView('location'));
  document.getElementById('sectorViewBtn').addEventListener('click', () => switchView('sector'));
  
  // Chart button
  document.getElementById('chartButton').addEventListener('click', openChartsModal);
  
  // Add event delegation for dynamically created elements
  document.addEventListener('click', function(e) {
    // Handle view details buttons in location view
    if (e.target.closest('.view-details-btn')) {
      const button = e.target.closest('.view-details-btn');
      const index = button.getAttribute('data-index');
      const location = mainSheetData.find(loc => String(loc._index) === String(index));
      if (location) {
        openDetailModal(location);
      }
    }

    // Handle sector detail view buttons
    if (e.target.closest('.view-sector-details-btn')) {
      const button = e.target.closest('.view-sector-details-btn');
      const sector = button.getAttribute('data-sector');
      if (sector) {
        openSectorDetailModal(sector);
      }
    }
    
    // Handle "Go to Location" buttons in service cards and map popups
    if (e.target.closest('.go-to-location-btn')) {
      const button = e.target.closest('.go-to-location-btn');
      const lat = parseFloat(button.getAttribute('data-lat'));
      const lon = parseFloat(button.getAttribute('data-lon'));
      const provider = button.getAttribute('data-provider') || 'Service Location';
      
      if (!isNaN(lat) && !isNaN(lon)) {
        // Check which map is currently active
        const detailModal = document.getElementById('detailModal');
        const sectorModal = document.getElementById('sectorDetailModal');
        
        if (detailModal.classList.contains('show')) {
          // Add a pinned marker to the modal map
          if (modalMap) {
            clearPinnedMarkers();
            addPinnedMarker(lat, lon, 'Service Location', provider);
          }
        } else if (sectorModal.classList.contains('show')) {
          // Add a pinned marker to the sector modal map
          if (sectorModalMap) {
            clearSectorPinnedMarkers();
            addSectorPinnedMarker(lat, lon, 'Service Location', provider);
          }
        }
      }
    }
  });

  // Auto-load the file when the page opens
  autoLoadExcelFile();
});

// Export functions for global access
window.processWorkbook = processWorkbook;
window.openDetailModal = openDetailModal;
window.openSectorDetailModal = openSectorDetailModal;
window.initializeModalMap = initializeModalMap;
window.openChartsModal = openChartsModal;
</script>
</body>
</html>
